#!/bin/bash
set -e

# --- Usage ---
if [[ "$1" == "--usage" ]]; then
  echo "Regenerates a past response (default: last) based on new instructions."
  exit 0
fi

# Default index
INDEX="-1"

# If the first arg is a number, treat it as the index
if [[ "$1" =~ ^-?[0-9]+$ ]]; then
    INDEX="$1"
    shift
fi

# Validate that we have an instruction
if [ $# -eq 0 ]; then
  echo "Error: Missing instruction."
  echo "Usage: aico refine [index] \"<instruction>\" [--model ...]"
  exit 1
fi

# Define System Prompt
export SYSTEM_PROMPT="You are an automated Refinement Engine.
Your goal is to rewrite the LAST Assistant response to satisfy the user's new instruction.

**CRITICAL STATE RULES:**
1. The XML <context> block contains the **live, current file state**.
2. The previous Assistant response (which you are refining) has **NOT** been applied or finalized.
3. **If** your output involves code or diffs, you MUST generate them based strictly on the content in <context>, ignoring any changes implied by the chat history that are not present in the files.

**OUTPUT RULES:**
- Output ONLY the replacement content (whether text, plan, code, or diff).
- Do NOT output conversational filler (e.g., 'Here is the fixed version')."

# Ephemeral Execution Setup
# We run the prompt in a temporary, forked session.
# This avoids modifying the main history stack (no "undo" needed) and prevents index drift.
# We capture the result via a side-channel file to preserve TTY output for the prompt.

# Generate unique name using python for portability
SESSION_NAME="refine-$(python3 -c 'import secrets; print(secrets.token_hex(4))')"
export PAYLOAD=$(mktemp)
cleanup() {
    rm -f "$PAYLOAD"
}
trap cleanup EXIT

echo "Refining response at index $INDEX..."

# 1. Execute inside ephemeral fork
#    - aico prompt: Shows streaming output to user
#    - aico last: Captures the final response content to our payload file
aico session-fork --ephemeral "$SESSION_NAME" -- bash -c 'aico prompt --system-prompt "$SYSTEM_PROMPT" "$@" && aico last --verbatim > "$PAYLOAD"' -- "$@"

# 2. Apply to Main Session in-place
if [ -s "$PAYLOAD" ]; then
    cat "$PAYLOAD" | aico edit "$INDEX"
    echo "Refinement complete."
else
    echo "Refinement failed or returned empty content."
    exit 1
fi
