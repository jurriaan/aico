#!/usr/bin/env python

import subprocess
import sys
from datetime import UTC, datetime

# --- Addon Boilerplate ---
# This allows the addon to import from the `aico` library.
try:
    from aico.core.session_context import find_message_pairs
    from aico.core.session_persistence import get_persistence
    from aico.lib.models import (
        AssistantChatMessage,
        Mode,
        UserChatMessage,
    )
except ImportError as e:
    print(
        "Error: Could not import the 'aico' library. Ensure `aico` is installed "
        f"in your environment (e.g., via `uv tool install`). Details: {e}",
        file=sys.stderr,
    )
    sys.exit(1)


# --- Addon Discovery ---
if "--usage" in sys.argv:
    print("Generate a summary of the active history and reset the session.")
    sys.exit(0)


# --- Summarization Logic ---

SUMMARIZER_SYSTEM_PROMPT = """You are an expert technical writer and minute-taker. Your task is to analyze the provided conversation log and produce a comprehensive, objective summary. Focus on capturing the rationale for key decisions, evolution of key concepts and approaches, development narrative, current state, and final outcomes, while preserving and integrating details from all prior exchanges for full continuity. The summary should be suitable for a new developer to get up to speed on the project's history without needing to read the entire log."""
SUMMARIZER_USER_PROMPT = """Your goal is to synthesize a two-part document from the log provided on stdin.

First, create a concise summary of the most recent developments from our immediate conversation under a `### Recent Developments` heading. This part is crucial for continuing our work.
If applicable, include a concise summary of previous developments (mentioned in earlier summary documents) under this heading as well.

Second, create a comprehensive, self-contained `### Comprehensive Project Summary` that serves as a full onboarding document. For this part, find and integrate the content of any previous summaries in the log with the project's current state (from files, the conversation log and recent decisions).
"""


def main() -> None:
    # 1. Get the formatted log from `aico dump-history`
    print("Exporting conversation log...")
    dump_history_proc = subprocess.run(
        ["aico", "dump-history"],
        capture_output=True,
        check=True,
        text=True,
        encoding="utf-8",
    )
    markdown_log = dump_history_proc.stdout

    if not markdown_log:
        print("No active history to summarize. Aborting.")
        sys.exit(0)

    # 2. Generate the summary in isolation, without including historical context
    print("Invoking AI to generate summary (without history)...")
    subprocess.run(
        [
            "aico",
            "ask",
            "--no-history",
            "--system-prompt",
            SUMMARIZER_SYSTEM_PROMPT,
            SUMMARIZER_USER_PROMPT,
        ],
        input=markdown_log,
        check=True,
        text=True,
        encoding="utf-8",
    )

    # 3. Archive the summarization turn so it is not included in future active history
    print("Archiving the summarization turn...")
    subprocess.run(["aico", "undo"], check=True)
    print("Summary generated and archived successfully.")

    # 4. Reload session, extract summary, inject a new priming pair, and reset history
    print("Resetting session to start with the new summary...")
    persistence = get_persistence()
    _, session_data = persistence.load()

    # The generated summary is the content of the last assistant message (which we just undid)
    last_message = session_data.chat_history[-1]
    if not isinstance(last_message, AssistantChatMessage):
        raise RuntimeError("Expected an AssistantChatMessage as the last entry after 'aico ask'")
    summary_text = last_message.content

    new_start_pair_index = len(find_message_pairs(session_data.chat_history))

    # First, update the history start pair metadata
    persistence.update_view_metadata(history_start_pair=new_start_pair_index)

    # Create the new priming pair to append
    injection_prompt = (
        "This is the summary generated from our previous conversations, "
        f"respond with just `OK` if you understand it:\n\n{summary_text}"
    )
    timestamp = datetime.now(UTC).isoformat()

    user_msg_to_append = UserChatMessage(
        role="user",
        content=injection_prompt,
        mode=Mode.CONVERSATION,
        timestamp=timestamp,
    )
    asst_msg_to_append = AssistantChatMessage(
        role="assistant",
        content="OK",
        mode=Mode.CONVERSATION,
        model=session_data.model,  # Keep the original model
        timestamp=timestamp,
        duration_ms=0,
    )

    # 5. Append the new priming pair, which also saves the final state
    persistence.append_pair(user_msg_to_append, asst_msg_to_append)
    print("\nSession history has been summarized and reset.")


if __name__ == "__main__":
    try:
        main()
    except subprocess.CalledProcessError as e:
        print("\nAn error occurred while running an 'aico' subcommand:", file=sys.stderr)
        stderr_output = e.stderr.strip() if e.stderr else "None"
        print(f"  STDERR: {stderr_output}", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"\nAn unexpected error occurred: {e}", file=sys.stderr)
        sys.exit(1)
