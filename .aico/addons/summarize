#!/bin/bash
#
# Addon: summarize
#
# Archives the active conversation history as a timestamped Markdown summary in
# `.aico/summaries/YYYYMMDDTHHMMSS_PROJECT_SUMMARY.md`, creates/updates a symlink
# `PROJECT_SUMMARY.md` at project root, resets active history to empty via
# `set-history clear`, and adds the symlink to context if missing.
#
# Uses the existing `summarize` prompts for consistency.

set -euo pipefail

if [[ "${1-}" == "--usage" ]]; then
  echo "Archives active history as dated summary (symlink: PROJECT_SUMMARY.md), resets history, adds to context."
  exit 0
fi

PROJECT_ROOT=$(dirname "$AICO_SESSION_FILE")
SUMMARY_DIR="$PROJECT_ROOT/.aico/summaries"

# 1. Check for active history
DUMP_HISTORY=$(aico dump-history)
if [ -z "$DUMP_HISTORY" ]; then
  echo "No active history to summarize. Aborting."
  exit 0
fi

# 2. Generate summary (captures stdout, hides stderr/token info)
SYSTEM_PROMPT="You are an expert technical writer and minute-taker. Your task is to analyze the provided conversation log and produce a comprehensive, objective summary. Focus on capturing the rationale for key decisions, evolution of key concepts and approaches, development narrative, current state, and final outcomes, while preserving and integrating details from all prior exchanges for full continuity. The summary should be suitable for a new developer to get up to speed on the project's history without needing to read the entire log."

USER_PROMPT="Your goal is to synthesize a two-part document from the log provided on stdin.

First, create a concise summary of the most recent developments from our immediate conversation under a \`### Recent Developments\` heading. This part is crucial for continuing our work.
If applicable, include a concise summary of previous developments (mentioned in earlier summary documents) under this heading as well.

Second, create a comprehensive, self-contained \`### Comprehensive Project Summary\` that serves as a full onboarding document. For this part, find and integrate the content of any previous summaries in the log with the project's current state (from files, the conversation log and recent decisions)."

echo "Generating summary..."
echo
echo "$DUMP_HISTORY" | aico ask --no-history --system-prompt "$SYSTEM_PROMPT" "$USER_PROMPT" 2>/dev/null

# 3. Undo the summarization turn + clear active history
aico undo >/dev/null 2>/dev/null
aico set-history clear

# 4. Write timestamped archive + update symlink
mkdir -p "$SUMMARY_DIR"
TIMESTAMP=$(date +%Y%m%dT%H%M%S)
SUMMARY_FILE="$SUMMARY_DIR/${TIMESTAMP}_PROJECT_SUMMARY.md"
aico last>"$SUMMARY_FILE"
ln -sf "$SUMMARY_FILE" "$PROJECT_ROOT/PROJECT_SUMMARY.md"

# 5. Add symlink to context if missing (check JSON output)
if ! aico dump-context | jq -e '.context_files[] | select(. == "PROJECT_SUMMARY.md")' >/dev/null 2>&1; then
  aico add "$PROJECT_ROOT/PROJECT_SUMMARY.md"
fi

echo "Archived summary to $SUMMARY_FILE (symlink: $PROJECT_ROOT/PROJECT_SUMMARY.md); history reset + context updated."
