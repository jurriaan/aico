#!/bin/bash
#
# This script is an example of an `aico` addon. Here's how it works:
#
# 1. DISCOVERY: `aico` finds this script because it's executable (`chmod +x`)
#    and located in the `./.aico/addons/` directory.
#
# 2. HELP TEXT: When `aico --help` is run, `aico` executes this script with
#    the `--usage` flag. The first line of output is used as the help text.
#
# 3. SESSION CONTEXT: `aico` sets the `AICO_SESSION_FILE` environment
#    variable. This addon doesn't need to read it directly, as it uses other
#    `aico` commands that implicitly use it.
#
# 4. DELEGATION: This addon orchestrates multiple `aico` commands (`aico ask`
#    and `aico history set`) to perform a complex workflow. This is a common
#    pattern for addons that manage session state.

set -e
set -o pipefail

if [[ "$1" == "--usage" ]]; then
  echo "Generate a comprehensive project summary and reset history to that summary"
  exit 0
fi

# Generate the summary using aico itself
SUMMARY_PROMPT="Generate a comprehensive project summary that can serve as a complete replacement for our conversation history for a new developer or an AI without any previous context. This summary does not need to include any diffs you generated, but may include the things you changed, the reason behind it (i.e. the why), and architectural considerations / discussion outcomes, keep in mind that the latest state of all files is given in this message. The goal of this summary is to be a full replacement of our conversation history. This should be a more comprehensive summary than the previous project summaries (i.e. make sure you do not leave out any details of the previous summaries and the current context)."

echo "Generating comprehensive project summary..."
aico ask "$SUMMARY_PROMPT"

echo "Resetting history to summary..."
aico history set -2

echo "Done. History now starts with the comprehensive summary."
